<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictator AI Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="newChat()">
                    <span>‚ûï</span>
                    <span>New Chat</span>
                </button>
            </div>
            <div class="chat-history" id="chatHistory">
                <!-- Chat sessions dynamically inserted here -->
            </div>
        </div>
        <div class="role-selector">
    <label for="roleSelect">üé≠ Select Role:</label>
    <select id="roleSelect">
        <option value="Hitler's close associate" selected>Hitler's close associate</option>
        <option value="Jews">Jews</option>
        <option value="American Journalist">American Journalist</option>
        <option value="German Young boy">German Young boy</option>
        
    </select>
</div>


        <!-- Main Chat Area -->
        <div class="main">
            <div class="topbar">
                <div class="topbar-left">
                    <button class="menu-btn" id="menuBtn" onclick="toggleSidebar()">‚ò∞</button>
                    <h1>
                        <span>ü§ñ</span>
                        <span>Dictator AI</span>
                    </h1>
                </div>
                <div class="top-buttons">
                    <div class="user-info">
                        üë§ <span id="usernameDisplay">{{ username }}</span>
                    </div>
                    <form action="/logout" method="GET" style="display:inline;">
                        <button type="submit" id="logoutBtn">Logout</button>
                    </form>
                </div>
            </div>

            <!-- Chat messages -->
            <div class="chatbox" id="chatbox">
                <div class="messages" id="messages">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <h2>How can I help you today?</h2>
                        <p>Start a conversation by typing a message below</p>
                    </div>
                </div>
            </div>

            <!-- Input area -->
            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="userInput" 
                            placeholder="Message Dictator AI..." 
                            autocomplete="off"
                        />
                        <button id="sendBtn">
                            <span>Send</span>
                            <span>‚Üë</span>
                        </button>
                    </div>
                    <div class="input-hint">Press Enter to send</div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // -------------- GLOBAL STATE --------------
    let currentSessionId = null;

    document.addEventListener("DOMContentLoaded", async () => {
        await loadSessions();
        document.getElementById("sendBtn").addEventListener("click", sendMessage);
        document.getElementById("userInput").addEventListener("keypress", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
        });
    });

    // -------------- SIDEBAR --------------
    function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
        document.getElementById("sidebarOverlay").classList.toggle("active");
    }

    async function loadSessions() {
        try {
            const res = await fetch("/sessions");
            const data = await res.json();
            if (data.status === "ok") {
                const historyDiv = document.getElementById("chatHistory");
                historyDiv.innerHTML = "";
                if (data.sessions.length === 0) {
                    historyDiv.innerHTML = `<p class='no-history'>No chats yet</p>`;
                } else {
                    data.sessions.forEach(sess => {
                        const item = document.createElement("div");
                        item.classList.add("history-item");
                        // item.textContent = `Chat - ${new Date(sess.updated_at).toLocaleString()}`;
                        item.innerHTML = `
    <span class="history-title">Chat - ${new Date(sess.updated_at).toLocaleString()}</span>
    <div class="history-menu">
        <span class="dots">‚ãÆ</span>
        <div class="menu-dropdown">
            <button onclick="deleteChat('${sess.session_id}')">Delete</button>
        </div>
    </div>
`;                   

                        item.onclick = () => loadChat(sess.session_id);
                        // Prevent click on dots from opening chat
item.querySelector(".history-menu").addEventListener("click", (e) => {
    e.stopPropagation();
});
                        historyDiv.appendChild(item);
                    });
                }
            }
        } catch (err) {
            console.error("Error loading sessions", err);
        }
    }

    // -------------- NEW CHAT --------------
    async function newChat() {
        const res = await fetch("/new_chat", { method: "POST" });
        const data = await res.json();
        if (data.status === "ok") {
            currentSessionId = data.session_id;
            document.getElementById("messages").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üí¨</div>
                    <h2>New Chat Started</h2>
                    <p>Say something to Dictator AI...</p>
                </div>`;
            await loadSessions();
        } else {
            alert("Failed to start new chat. Please login again.");
            window.location.href = "/login";
        }
    }

    // -------------- LOAD CHAT HISTORY --------------
    async function loadChat(sessionId) {
        currentSessionId = sessionId;
        const res = await fetch(`/get_history/${sessionId}`);
        const data = await res.json();
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";

        if (data.status === "ok" && data.messages.length > 0) {
            data.messages.forEach(msg => {
                const msgDiv = document.createElement("div");
                msgDiv.classList.add("message", msg.role);
                msgDiv.innerHTML = `<p>${msg.content}</p>`;
                messagesDiv.appendChild(msgDiv);
            });
        } else {
            messagesDiv.innerHTML = `<p class="no-history">No messages yet in this chat</p>`;
        }

        scrollToBottom();
    }

    // -------------- SEND MESSAGE --------------
    async function sendMessage() {
        const input = document.getElementById("userInput");
        const text = input.value.trim();
        if (!text) return alert("Please type a message!");
        if (!currentSessionId) {
            await newChat();
        }

        appendMessage("user", text);
        input.value = "";
        const selectedRole = document.getElementById("roleSelect").value;
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text, session_id: currentSessionId, role: selectedRole})
        });

        const data = await res.json();
        appendMessage("assistant", data.reply || "‚ö†Ô∏è No response from AI");
        scrollToBottom();
        await loadSessions();
    }

    // -------------- UI HELPERS --------------
    function appendMessage(role, content) {
        const messagesDiv = document.getElementById("messages");
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", role);
        msgDiv.innerHTML = `<p>${content}</p>`;
        messagesDiv.appendChild(msgDiv);
        scrollToBottom();
    }

    function scrollToBottom() {
        const chatbox = document.getElementById("chatbox");
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Prevent cached page reuse after logout
    window.addEventListener('pageshow', function (event) {
        if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
            window.location.reload();
        }
    });
    // Handle opening/closing dropdown menus
document.addEventListener("click", (e) => {
    document.querySelectorAll(".history-menu").forEach(menu => {
        if (!menu.contains(e.target)) {
            menu.classList.remove("active");
        }
    });

    if (e.target.classList.contains("dots")) {
        e.target.parentElement.classList.toggle("active");
    }
});
    
async function deleteChat(sessionId) {
    if (!confirm("Delete this chat permanently?")) return;

    const res = await fetch(`/delete_session/${sessionId}`, {
        method: "DELETE"
    });

    const data = await res.json();

    if (data.status === "ok") {
        await loadSessions();

        document.getElementById("messages").innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üóëÔ∏è</div>
                <h2>Chat Deleted</h2>
            </div>
        `;
    } else {
        alert("Failed to delete chat");
    }
}

    </script>
</body>
</html>
