<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta charset="UTF-8">
    <title>Dictator AI Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">

            <div class="sidebar-header">
                 <div class="sidebar-top-row">
                    <h2 class="sidebar-title">Chats</h2>
                    <button class="close-sidebar-btn" onclick="toggleSidebar()">‚úï</button><!-- Close button -->
                </div>
                <button class="new-chat-btn" onclick="newChat()">
                    <span>‚ûï</span>
                    <span>New Chat</span>
                </button>
            </div>

            <div class="chat-history" id="chatHistory">
                <!-- History Loaded Here -->
            </div>
            <div class="sidebar-user-panel">
    <div class="sidebar-username">üë§ {{ username }}</div>
    <form action="/logout" method="GET">
        <button class="sidebar-logout-btn" type="submit">Logout</button>
    </form>
</div>
        </div>
         <button class="show-history-btn" id="showHistoryBtn" onclick="toggleSidebar()">
            <span>üìã</span>
            <span>History</span><!-- History Button  -->
        </button>
        <!-- Role Selector -->
        <!-- <div class="role-selector">
            <label for="roleSelect">üé≠ Select Role:</label>
            <select id="roleSelect">
                <option value="Hitler's close associate" selected>Hitler's close associate</option>
                <option value="Jews">Jews</option>
                <option value="American Journalist">American Journalist</option>
                <option value="German Young boy">German Young boy</option>
            </select>
        </div> -->

        <!-- Main Chat Area -->
        <div class="main">
            <div class="topbar">
                <div class="topbar-left">
                    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                   <h1>
    <img src="{{ url_for('static', filename='Logo.jpg') }}" alt="Dictator AI Logo" class="logo-img">
    Dictator AI
</h1>
                </div>
                <div class="top-buttons">
                    <div class="user-info">
                        üë§ <span id="usernameDisplay">{{ username }}</span>
                    </div>
                    <form action="/logout" method="GET" style="display:inline;">
                        <button type="submit" id="logoutBtn">Logout</button>
                    </form>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chatbox" id="chatbox">
                <div class="messages" id="messages">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <h2>How can I help you today?</h2>
                        <p>Start a conversation below</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-container">
                         <button class="selector-btn" id="modelBtn" title="Select Model">
                ü§ñ
            </button>
            <button class="selector-btn" id="roleBtn" title="Select Role">
                üé≠
            </button>
                        <textarea id="userInput" placeholder="Message Dictator AI..." autocomplete="off" rows="1"></textarea>
                        <button id="sendBtn">
                            <span>Send</span>
                            <span>‚Üë</span>
                        </button>
                    </div>
                    <div class="input-hint">Press Enter to send, Shift+Enter for new line</div>
                </div>
                 <div class="selector-dropdown" id="modelDropdown">
                <div class="dropdown-header">Select Model</div>
                <select id="modelSelect" size="4">
                    <option value="gpt-4" selected>GPT-4</option>
                    <option value="gpt-3.5">GPT-3.5 Turbo</option>
                    <option value="claude">Claude</option>
                    <option value="gemini">Gemini Pro</option>
                </select>
            </div>
                

            <div class="selector-dropdown" id="roleDropdown">
                <div class="dropdown-header">Select Role</div>
                <select id="roleSelect" size="4">
                    <option value="Hitler's close associate" selected>Hitler's close associate</option>
                    <option value="Jews">Jews</option>
                    <option value="American Journalist">American Journalist</option>
                    <option value="German Young boy">German Young boy</option>
                </select>
            </div>

        
            </div>
        </div>
    </div>

<script>
let currentSessionId = null;

// On Page Load
document.addEventListener("DOMContentLoaded", async () => {
    await loadSessions();

    const textarea = document.getElementById("userInput");

    // Auto-resize textarea
    textarea.addEventListener("input", function() {
        this.style.height = "44px"; // Reset to minimum
        this.style.height = Math.min(this.scrollHeight, 200) + "px"; // Grow up to 200px
    });

    document.getElementById("sendBtn").addEventListener("click", sendMessage);
    
    // Updated keypress handler - Enter sends, Shift+Enter for new line
    textarea.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    document.getElementById("modelBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        toggleDropdown('modelDropdown', 'modelBtn');
    });
    
    // Role selector button
    document.getElementById("roleBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        toggleDropdown('roleDropdown', 'roleBtn');
    });
    
    // Auto-close dropdown when selecting
    document.getElementById("modelSelect").addEventListener("change", () => {
        document.getElementById("modelDropdown").classList.remove("active");
        document.getElementById("modelBtn").classList.remove("active");
    });
    
    document.getElementById("roleSelect").addEventListener("change", () => {
        document.getElementById("roleDropdown").classList.remove("active");
        document.getElementById("roleBtn").classList.remove("active");
    });
});



//Chnage this fucntion to side bar handling okay
// Sidebar Toggle - works on both desktop and mobile
function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebarOverlay");
    const historyBtn = document.getElementById("showHistoryBtn");
    
    // Better mobile detection using computed styles
    const sidebarStyles = window.getComputedStyle(sidebar);
    const isMobile = sidebarStyles.position === 'fixed';
    
    if (isMobile) {
        // Mobile: slide sidebar in/out
        sidebar.classList.toggle("active");
        overlay.classList.toggle("active");
        
        // Remove desktop class if exists
        sidebar.classList.remove("collapsed");
        historyBtn.style.display = "none";
    } 
    else {
        // Desktop: collapse sidebar
        const isCollapsed = sidebar.classList.toggle("collapsed");
        
        // Show/hide history button
        historyBtn.style.display = isCollapsed ? "flex" : "none";
        
        // Remove mobile classes and overlay
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
    }
}

// Handle window resize - cleanup when switching between desktop/mobile
let resizeTimer;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        const historyBtn = document.getElementById("showHistoryBtn");
        
        // Check current mode
        const sidebarStyles = window.getComputedStyle(sidebar);
        const isMobile = sidebarStyles.position === 'fixed';
        
        if (isMobile) {
            // Clean up desktop classes
            sidebar.classList.remove("collapsed");
            historyBtn.style.display = "none";
        } else {
            // Clean up mobile classes
            sidebar.classList.remove("active");
            overlay.classList.remove("active");
        }
    }, 250);
});


// Selector Dropdown Toggle
function toggleDropdown(dropdownId, btnId) {
    const dropdown = document.getElementById(dropdownId);
    const btn = document.getElementById(btnId);
    const allDropdowns = document.querySelectorAll('.selector-dropdown');
    const allBtns = document.querySelectorAll('.selector-btn');
    
    // Close all other dropdowns
    allDropdowns.forEach(d => {
        if (d.id !== dropdownId) {
            d.classList.remove('active');
        }
    });
    
    // Remove active from all buttons
    allBtns.forEach(b => {
        if (b.id !== btnId) {
            b.classList.remove('active');
        }
    });
    
    // Toggle current dropdown
    dropdown.classList.toggle('active');
    btn.classList.toggle('active');
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    const dropdowns = document.querySelectorAll('.selector-dropdown');
    const buttons = document.querySelectorAll('.selector-btn');
    
    let clickedInside = false;
    
    dropdowns.forEach(dropdown => {
        if (dropdown.contains(e.target)) clickedInside = true;
    });
    
    buttons.forEach(btn => {
        if (btn.contains(e.target)) clickedInside = true;
    });
    
    if (!clickedInside) {
        dropdowns.forEach(d => d.classList.remove('active'));
        buttons.forEach(b => b.classList.remove('active'));
    }
});


// ---------- Load Chat Sessions ----------
async function loadSessions() {
    try {
        const res = await fetch("/sessions");
        const data = await res.json();

        const historyDiv = document.getElementById("chatHistory");
        historyDiv.innerHTML = "";

        if (data.sessions.length === 0) {
            historyDiv.innerHTML = `<p class="no-history">No chats yet</p>`;
            return;
        }

        data.sessions.forEach(sess => {
            const item = document.createElement("div");
            item.classList.add("history-item");
            //Chnage is here for history renameing okay 
            item.innerHTML = `
               <span class="history-title">${sess.title ? sess.title : "New Chat"}</span>
                <div class="history-menu">
                    <span class="dots">‚ãÆ</span>
                    <div class="menu-dropdown">
                        <button onclick="deleteChat('${sess.session_id}')">Delete</button>
                    </div>
                </div>
            `;


            // Clicking item loads chat
            item.addEventListener("click", () => loadChat(sess.session_id));

            // But clicking the dots SHOULD NOT trigger loading the chat
            item.querySelector(".history-menu").addEventListener("click", (e) => {
                e.stopPropagation();
                e.currentTarget.classList.toggle("active");
            });

            historyDiv.appendChild(item);
        });

    } catch (err) {
        console.error("Error loading sessions", err);
    }
}

// Click outside closes dropdowns
document.addEventListener("click", (e) => {
    document.querySelectorAll(".history-menu").forEach(menu => {
        if (!menu.contains(e.target)) {
            menu.classList.remove("active");
        }
    });
});

// -------- Create New Chat --------
async function newChat() {
    const res = await fetch("/new_chat", { method: "POST" });
    const data = await res.json();

    if (data.status === "ok") {
        currentSessionId = data.session_id;
        document.getElementById("messages").innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <h2>New Chat Started</h2>
            </div>`;
        await loadSessions();
    }
}

// -------- Load Chat History --------
async function loadChat(sessionId) {
    currentSessionId = sessionId;

    const res = await fetch(`/get_history/${sessionId}`);
    const data = await res.json();

    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";

    if (data.status === "ok" && data.messages.length > 0) {
        data.messages.forEach(msg => {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message", msg.role);
            msgDiv.innerHTML = `<p>${msg.content}</p>`;
            messagesDiv.appendChild(msgDiv);
        });
    } else {
        messagesDiv.innerHTML = `<p class="no-history">No messages yet in this chat</p>`;
    }
    scrollToBottom();
}

// -------- Send Message --------
async function sendMessage() {
    const input = document.getElementById("userInput");
    const text = input.value.trim();
    if (!text) return;

    if (!currentSessionId) {
        await newChat();
    }

    appendMessage("user", text);
    input.value = "";
    input.style.height = "44px"; // Reset height after sending

    const selectedRole = document.getElementById("roleSelect").value;
    const selectedModel = document.getElementById("modelSelect").value;  // ADD THIS


    const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            message: text,
            session_id: currentSessionId,
            role: selectedRole,
            model: selectedModel  // ADD THIS
        })
    });

    const data = await res.json();
    appendMessage("assistant", data.reply || "‚ö†Ô∏è No response from AI");
    scrollToBottom();
    await loadSessions();
}

function appendMessage(role, content) {
    const messagesDiv = document.getElementById("messages");
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", role);
    msgDiv.innerHTML = `<p>${content}</p>`;
    messagesDiv.appendChild(msgDiv);
}

function scrollToBottom() {
    const chatbox = document.getElementById("chatbox");
    chatbox.scrollTop = chatbox.scrollHeight;
}

// -------- Delete Chat --------
async function deleteChat(sessionId) {
    if (!confirm("Delete this chat permanently?")) return;

    const res = await fetch(`/delete_session/${sessionId}`, {
        method: "DELETE"
    });

    const data = await res.json();
    if (data.status === "ok") {
        await loadSessions();
        document.getElementById("messages").innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üóëÔ∏è</div>
                <h2>Chat Deleted</h2>
            </div>`;
    }
}
</script>

</body>
</html>